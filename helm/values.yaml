# Airflow Helm Chart Values
# Configuration for Airflow 3.x deployment on Kubernetes

# Airflow version
airflowVersion: "3.0.0"

# Default Airflow image
defaultAirflowRepository: apache/airflow
defaultAirflowTag: "3.0.0"

# Executor configuration
executor: "LocalExecutor"

# Database configuration (PostgreSQL)
# For local development, the embedded Postgres is fine
# For production, set enabled: false and use an external database
# See: https://airflow.apache.org/docs/helm-chart/stable/production-guide.html#database
postgresql:
  enabled: true
  auth:
    username: airflow
    password: airflow
    database: airflow
  # Override image to use official postgres (bitnami tags may not be available)
  image:
    registry: docker.io
    repository: postgres
    tag: "16-alpine"  # Official postgres image that works with kind
    pullPolicy: IfNotPresent
  # Official postgres image uses different env vars than bitnami
  # Override the connection to use our configured user
  extraEnvVars:
    - name: POSTGRES_USER
      value: "airflow"
    - name: POSTGRES_PASSWORD
      value: "airflow"
    - name: POSTGRES_DB
      value: "airflow"
  persistence:
    enabled: true
    size: 8Gi
    storageClassName: standard  # Use kind's default storage class

# Redis (not needed for LocalExecutor, but included for future CeleryExecutor use)
redis:
  enabled: false

# Database connection configuration
# Override to use the correct credentials we configured
data:
  metadataConnection:
    user: airflow
    pass: airflow
    protocol: postgresql
    host: airflow-postgresql
    port: 5432
    db: airflow

# Airflow configuration
config:
  core:
    executor: LocalExecutor
    parallelism: 32
    dag_concurrency: 16
    max_active_runs_per_dag: 16
    load_examples: "False"
    dags_are_paused_at_creation: "True"
  logging:
    logging_level: INFO
  api:
    auth_backend: "airflow.api.auth.backend.basic_auth"
  webserver:
    expose_config: "False"
    base_url: http://localhost:8080

# Users configuration
users:
  - username: admin
    password: admin
    role: Admin
    email: admin@example.com
    firstName: Admin
    lastName: User

# Webserver configuration
webserver:
  enabled: true
  replicas: 1
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1000m
      memory: 2Gi
  service:
    type: ClusterIP

# Webserver secret key (required to prevent unnecessary restarts)
# Generate with: python3 -c "import secrets; print(secrets.token_hex(32))"
webserverSecretKey: "a8be0bce2df648afafe3afb1f290f0734e53d5216c8ff2e69a0619638ccaa05b"

# Scheduler configuration
scheduler:
  enabled: true
  replicas: 1
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1000m
      memory: 2Gi
  # Environment variables for Dog Breeds Database connection
  env:
    - name: DOG_BREEDS_DB_HOST
      valueFrom:
        configMapKeyRef:
          name: dog-breeds-db-connection
          key: DOG_BREEDS_DB_HOST
          optional: true
    - name: DOG_BREEDS_DB_PORT
      valueFrom:
        configMapKeyRef:
          name: dog-breeds-db-connection
          key: DOG_BREEDS_DB_PORT
          optional: true
    - name: DOG_BREEDS_DB_NAME
      valueFrom:
        configMapKeyRef:
          name: dog-breeds-db-connection
          key: DOG_BREEDS_DB_NAME
          optional: true
    - name: DOG_BREEDS_DB_USER
      valueFrom:
        configMapKeyRef:
          name: dog-breeds-db-connection
          key: DOG_BREEDS_DB_USER
          optional: true
    - name: DOG_BREEDS_DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: dog-breeds-db-connection
          key: DOG_BREEDS_DB_PASSWORD
          optional: true

# Triggerer configuration (for deferred tasks)
triggerer:
  enabled: true
  replicas: 1
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi

# DAG processor configuration
dagProcessor:
  enabled: true
  replicas: 1
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi

# DAGs configuration
dags:
  gitSync:
    enabled: false
  persistence:
    enabled: true
    size: 1Gi
    storageClassName: standard  # Use kind's default storage class

# Logs persistence
# Disabled for local development with kind (ReadWriteMany not supported by local-path)
# Logs will be stored in emptyDir (ephemeral, lost on pod restart)
# For production, enable persistence with a storage class that supports ReadWriteMany
logs:
  persistence:
    enabled: false  # Disable for kind compatibility

# Resource limits for local development
resources:
  requests:
    cpu: 200m
    memory: 512Mi
  limits:
    cpu: 1000m
    memory: 2Gi

# Security context
securityContext:
  fsGroup: 50000
  runAsUser: 50000

# Service account
serviceAccount:
  create: true

# Pod disruption budget (disabled for local dev)
podDisruptionBudget:
  enabled: false

# Network policies (disabled for local dev)
networkPolicies:
  enabled: false

# Ingress (disabled - using port-forward for local access)
ingress:
  enabled: false

# Metrics (optional, disabled for local dev)
metrics:
  enabled: false

# Flower (Celery monitoring, not needed for LocalExecutor)
flower:
  enabled: false

# Extra Python packages to install
extraPipPackages:
  - "psycopg2-binary==2.9.9"
  - "requests==2.31.0"
